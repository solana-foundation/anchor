#!/usr/bin/env node

const fs = require("fs");
const { spawnSync } = require("child_process");

function appendLog({ logfile, args }) {
  if (!logfile) return;
  const entry = {
    command: "solana",
    args,
  };
  fs.appendFileSync(logfile, JSON.stringify(entry, null, 2) + "\n");
}

function proxyToRealBinary(args) {
  const realBinary = process.env.MOCK_SOLANA_REAL_BINARY;
  if (!realBinary) return null;

  const result = spawnSync(realBinary, args, {
    stdio: "inherit",
  });

  return result ? result.status ?? 0 : 0;
}

function handleProgramDeploy(args) {
  // Check for forced exit code (used by deploy failure tests)
  const forceExitCode = process.env.MOCK_SOLANA_FORCE_EXIT_CODE;
  if (forceExitCode !== undefined) {
    const code = Number.parseInt(forceExitCode, 10);
    process.exit(Number.isNaN(code) ? 1 : code);
  }

  // Check for upgrade-specific error scenarios
  const upgradeError = process.env.MOCK_SOLANA_UPGRADE_ERROR;
  if (upgradeError) {
    const exitCode = Number.parseInt(
      process.env.MOCK_SOLANA_UPGRADE_EXIT_CODE ?? "1",
      10,
    );
    process.stderr.write(upgradeError + "\n");
    process.exit(Number.isNaN(exitCode) ? 1 : exitCode);
  }

  // Extract program ID and binary path from arguments
  let programId;
  let binaryPath;
  let keypairPath;

  for (let i = 0; i < args.length; i++) {
    if (args[i] === "--program-id" && i + 1 < args.length) {
      programId = args[i + 1];
    } else if (args[i] === "--keypair" && i + 1 < args.length) {
      keypairPath = args[i + 1];
    } else if (!args[i].startsWith("--") && args[i].endsWith(".so")) {
      binaryPath = args[i];
    }
  }

  // Validate expected program ID if provided
  const expectedProgramId = process.env.MOCK_SOLANA_UPGRADE_PROGRAM_ID;
  if (expectedProgramId && programId !== expectedProgramId) {
    process.stderr.write(`Error: Unexpected program ID: ${programId}\n`);
    process.exit(1);
  }

  // Validate binary path if provided
  const expectedBinaryPath = process.env.MOCK_SOLANA_UPGRADE_BINARY_PATH;
  if (expectedBinaryPath && binaryPath && !binaryPath.includes(expectedBinaryPath)) {
    process.stderr.write(`Error: Unexpected binary path: ${binaryPath}\n`);
    process.exit(1);
  }

  // Check if binary file exists
  if (binaryPath && !fs.existsSync(binaryPath)) {
    process.stderr.write(`Error: Program binary not found: ${binaryPath}\n`);
    process.exit(1);
  }

  // Only output upgrade-specific information if we're in upgrade test mode
  // (indicated by MOCK_SOLANA_UPGRADE_PROGRAM_ID being set)
  if (expectedProgramId || process.env.MOCK_SOLANA_UPGRADE_OUTPUT) {
    // Generate or use custom output
    const customOutput = process.env.MOCK_SOLANA_UPGRADE_OUTPUT;
    if (customOutput) {
      process.stdout.write(customOutput + "\n");
    } else {
      // Default upgrade success output
      const signature = process.env.MOCK_SOLANA_SIGNATURE || "5" + "X".repeat(87);
      process.stdout.write(`Program Id: ${programId || "UnknownProgram111111111111111111111111111"}\n\n`);
      process.stdout.write(`Signature: ${signature}\n`);
    }
  }
  // For deploy tests, just exit successfully without extra output
}

function main() {
  const args = process.argv.slice(2);

  const logfile = process.env.MOCK_SOLANA_LOG_PATH;
  appendLog({ logfile, args });

  // Handle 'program deploy' command (used by anchor upgrade)
  if (args[0] === "program" && args[1] === "deploy") {
    handleProgramDeploy(args.slice(2));
    process.exit(0);
  }

  if (process.env.MOCK_SOLANA_FAIL === "1") {
    process.exit(1);
  }

  const stdout = process.env.MOCK_SOLANA_STDOUT;
  if (stdout) {
    process.stdout.write(stdout);
  }

  const stderr = process.env.MOCK_SOLANA_STDERR;
  if (stderr) {
    process.stderr.write(stderr);
  }

  const forceExitCode = process.env.MOCK_SOLANA_FORCE_EXIT_CODE;
  if (forceExitCode !== undefined) {
    const code = Number.parseInt(forceExitCode, 10);
    process.exit(Number.isNaN(code) ? 1 : code);
  }

  if (process.env.MOCK_SOLANA_PROXY === "1") {
    const status = proxyToRealBinary(args);
    process.exit(status ?? 0);
  }

  process.exit(0);
}

main();

